OK. This one feels like defeating the final boss in a videogame (e.g. The Legend of Zelda)

Before running FastSimCoal, we need to convert the vcf onto a SFS file. We algo need to guarantee the vcf was not trimmed for minimum allele frequency.

First, let's generate such vcf.
```
# 1. filters
vcftools --vcf Stygocapitella.subterranea.josemariobrancoi.westheidei.r50.p8.stacks.vcf \
--max-missing 0.25 --max-meanDP 100 --min-meanDP 10 --recode --stdout > Stygocapitella.subterranea.josemariobrancoi.westheidei.r50.p8.stacks.maxMeanDP100.maxMiss0.25.minMeanDP10.forFSC.vcf

# 2. removing individuals

vcftools --vcf Stygocapitella.subterranea.josemariobrancoi.westheidei.r50.p8.stacks.maxMeanDP100.maxMiss0.25.minMeanDP10.forFSC.vcf --missing-indv
cat out.imiss | awk '$5>0.90' |  awk 'FNR > 1 {print $1}' >  inds.to.remove

vcftools --vcf Stygocapitella.subterranea.josemariobrancoi.westheidei.r50.p8.stacks.maxMeanDP100.maxMiss0.25.minMeanDP10.forFSC.vcf \
--remove inds.to.remove --recode --stdout > vcfFSC.vcf
```

Now, we convert to SFS:

```
# We need: a file formated like:
# ind<tab>pop
# ind<tab>pop
# ...
# ind<tab>pop

# So we get this information from the vcf
bcftools query -l vcfFSC.vcf
awk '{if (NR!=1) {print }}' inds.tsv |  awk -F _ '{print }' > pops.tsv

paste inds.tsv pops.tsv > easySFS.input.tsv

# Now we need the SFS convetion

# preview and proj
easySFS.py -i ../1_vcf_without_MAFcut_off/2_individuals_removed/vcfFSC.vcf -p easySFS.input.tsv --preview
easySFS.py -i ../1_vcf_without_MAFcut_off/2_individuals_removed/vcfFSC.vcf -p easySFS.input.tsv --proj 20,20,20
```

Running FastSimCoal!

1. Do your models as in 11_fscScenarios (each model needs an .est and a .tpl file)

2. Create folders in the working directory, one for each scenario. Inside each make three folders: runs run_log best_likelihood_distributions

```
mkdir all_gene_flow  ancient_gene_flow  geographic_gene_flow  modern_gene_flow  no_gene_flow
for i in $(ls); do cd $i; mkdir runs run_log best_likelihood_distributions; cd ..; done
```
3. Then, you need to run each scenario (.est/.tpl) 10.000 times..by doing an array or a for loop (the array is much faster)

```
# Example:
MODEL=no_gene_flow
TEMPLATE=$MODEL.tpl
ESTIMATES=$MODEL.est
obs_file=vcfFSC_MSFS.obs

# set up output
OUT_DIR=/cluster/work/users/josece/stygo_fas_sim_coal/$MODEL/run_log

# set up workdir
for I in $(seq 1 10000)
WORKDIR=/cluster/work/users/josece/stygo_fas_sim_coal/$MODEL/runs/myarray_${I}
mkdir $WORKDIR
# We move to the working directory and copy the files there
cd $WORKDIR
echo "Running array number ${I}"
cp $obs_file ./${MODEL}_MSFS.obs
cp $TEMPLATE .
cp $ESTIMATES .

~/local_bin/fsc26_linux64/fsc26 -t $MODEL.tpl -e $MODEL.est -n 1 -C 10 -M -L 40 -c 20 -B 20 -m --multiSFS | tee run_${I}.log

done```

3. Now we need to see See which of the 10,000 runs has the .bestlhoods

```
cd run_log # (where we have your runs)

for i in $(seq 1 1000); do cat {MODELNAME}_${i}.bestlhoods | grep -v MaxObsLho od | awk -v var=$i '{print var,$NF-$(NF-1)}' | cut -f 1 -d "."; done > ../bestlhood.tsv

#this code let's you go on file 1 .. 2 .. 3 (otherwise unix goes 10000 .. 1000 .. 100 .. 10 .. 1 .. 10001 .. 1001 .. 9)
        #for i in $(seq 1 100000); do cat *.$i.bestlhoods # first you open each file
                # grep -v MaxObsLhood # you get the line you want (the file only has 2 lines)
                # awk -v var=$i '{print var,$NF-$(NF-1)}' #var adds the run_id. $NF-$(NF-1) substracts the end column with the column before so you get the smallest difference between observed and estimated likelihoods
                # cut -f 1 -d "." # to cut the value
                #  > ../best.run.${MODELNAME}.tsv # save

```

4. Now, we identify the run with the best run so we do some likelihood modeling.

We do this by:

```
cd $model
sort -k2 $MODELNAME.tsv | head
```

Save the model name in a text file. One dummy example:


```
<model>                                                 <run_ID>        <smallest difference between observed and estimated likelihoods>
all_gene_flow                                           <670>           <1842>
ancient_gene_flow                                       <146>           <1651>
geographic_gene_flow                                    <369>           <1956>
modern_gene_flow                                        <545>           <2164>
no_gene_flow                                            <117>           <1606>
```

5. We use the _maxL.par file (generated by the best run; notice that I provide mine in 11_fscScenarios) and the .obs file (generated in the beginning) and we run FastSimCoal 100 times.

To get the file you need to search the folder that was created by that run. Say:

```
cd no_gene_flow/runs/my_array_117/no_gene_flow
```
Now we run this file an the obs file 100 times.

```
cp ../../*par .
cp $obs_file ./${MODEL}_maxL_jointMAFpop1_0.obs
~/000_locally_installed_stuff/fsc26_linux64/fsc26 -i ${MODEL}_maxL.par -n1000000 -m -q -0

```
6. we get the .lhoods file from each of the 100 runs and format a file with the 100 ML distributions for each model

```
#run this on the folder where you have all the models (i.e. i=hybrid_etc)
for i in `ls`; do cd $i/; touch ${i}.lhoods; cd best_likelihood_distributions; for j in `ls`; do sed -n '2,3p' $j/*_maxL/*lhoods; done >> ../${i}.lhoods; cd ../..; done
```

Now plot this over R:

```
setwd("~/Desktop/tmp/")

all_gene_flow<-read.table("./all_gene_flow.lhoods")
ancient_gene_flow<-read.table("./ancient_gene_flow.lhoods")
ancient_sub_west_gene_flow<-read.table("ancient_sub_west_gene_flow.lhoods")
geographic_gene_flow<-read.table("geographic_gene_flow.lhoods")
modern_gene_flow<-read.table("modern_gene_flow.lhoods")
modern_gene_flow_i_and_s<-read.table("modern_gene_flow_i_and_s.lhoods")
modern_gene_flow_i_and_w<-read.table("modern_gene_flow_i_and_w.lhoods")
modern_gene_flow_s_and_w<-read.table("modern_gene_flow_s_and_w.lhoods")
no_gene_flow<-read.table("no_gene_flow.lhoods")

par(mfrow=c(1,1))


boxplot(range = 0,
        all_gene_flow$V1,
        ancient_gene_flow$V1,
        ancient_sub_west_gene_flow$V1,
        geographic_gene_flow$V1,
        modern_gene_flow$V1,
        modern_gene_flow_i_and_s$V1,
        modern_gene_flow_i_and_w$V1,
        modern_gene_flow_s_and_w$V1,
        no_gene_flow$V1,
        ylab="Likelihood",xaxt="n")

library(tidyverse)
#install.packages("ggthemes")
library(ggthemes)

all_gene_flow<-read.table("./all_gene_flow.lhoods") %>%
  rename(flow=V1)
all_gene_flow$ID<-"all_gene_flow"

ancient_gene_flow<-read.table("./ancient_gene_flow.lhoods") %>%
  rename(flow=V1)
ancient_gene_flow$ID<-"ancient_gene_flow"

ancient_sub_west_gene_flow<-read.table("ancient_sub_west_gene_flow.lhoods") %>%
  rename(flow=V1)
ancient_sub_west_gene_flow$ID<-"ancient_sub_west_gene_flow"

geographic_gene_flow<-read.table("geographic_gene_flow.lhoods") %>%
  rename(flow=V1)
geographic_gene_flow$ID<-"geographic_gene_flow"

modern_gene_flow<-read.table("modern_gene_flow.lhoods") %>%
  rename(flow=V1)
modern_gene_flow$ID<-"modern_gene_flow"

modern_gene_flow_i_and_s<-read.table("modern_gene_flow_i_and_s.lhoods") %>%
  rename(flow=V1)
modern_gene_flow_i_and_s$ID<-"modern_gene_flow_i_and_s"

modern_gene_flow_i_and_w<-read.table("modern_gene_flow_i_and_w.lhoods") %>%
  rename(flow=V1)
modern_gene_flow_i_and_w$ID<-"modern_gene_flow_i_and_w"

modern_gene_flow_s_and_w<-read.table("modern_gene_flow_s_and_w.lhoods") %>%
  rename(flow=V1)
modern_gene_flow_s_and_w$ID<-"modern_gene_flow_s_and_w"

no_gene_flow<-read.table("no_gene_flow.lhoods") %>%
  rename(flow=V1)
no_gene_flow$ID<-"no_gene_flow"

datacombined <- rbind(all_gene_flow,
                      ancient_gene_flow,
                      ancient_sub_west_gene_flow,
                      geographic_gene_flow,
                      modern_gene_flow,
                      modern_gene_flow_i_and_s,
                      modern_gene_flow_i_and_w,
                      modern_gene_flow_s_and_w,
                      no_gene_flow)

qplot(x=ID , y=flow , data=datacombined , geom=c("boxplot","jitter") , colour=ID) +
  theme_minimal()

qplot( x=ID , y=flow , data=datacombined , geom=c("boxplot","jitter") , colour=ID) +
  theme_hc()





```
